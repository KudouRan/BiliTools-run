"use strict";var e=require("crypto-js"),t=require("./run.js"),a=require("qs"),i=require("axios");function n(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function r(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(a){if("default"!==a){var i=Object.getOwnPropertyDescriptor(e,a);Object.defineProperty(t,a,i.get?i:{enumerable:!0,get:function(){return e[a]}})}})),t.default=e,Object.freeze(t)}require("path"),require("fs"),require("lodash"),require("nodemailer"),require("tencentcloud-sdk-nodejs");var s=r(e),o=n(i);function c(e,a,i,n,r){const s=t.getBiliJct(),o=s,c=[t.getLIVE_BUVID(),t.createUUID()];return{ua:t.TaskConfig.USER_AGENT,id:[i,a,r,e],csrf_token:s,csrf:o,device:c,uname:n}}async function f(){try{await async function(){const{data:e}=await o.default.get("https://api.live.bilibili.com/relation/v1/Feed/heartBeat");return e}()}catch{}}async function l(e){const{data:{area_id:a,parent_area_id:i,room_id:n}}=await t.getLiveRoomInfo(e);return{room_id:n,area_id:a,parent_area_id:i}}async function u(e,t){const i={id:JSON.stringify(e.id),device:JSON.stringify(e.device),ts:(new Date).getTime(),is_patch:0,heart_beat:"[]",ua:e.ua,visit_id:"",csrf:e.csrf,csrf_token:e.csrf_token};try{const{data:n,code:r}=await async function(e){const{data:t}=await o.default.post("https://live-trace.bilibili.com/xlive/data-interface/v1/x25Kn/E",a.stringify(e));return t}(i);if(0===r)return console.log(`进入【${e.uname}】的直播间`),t.v++,n}catch(e){console.error(e)}}async function d(e,t,i){if(i.v>6)return;const n={id:JSON.stringify(t.id),device:JSON.stringify(t.device),ets:e.timestamp,benchmark:e.secret_key,time:60,ts:(new Date).getTime(),ua:t.ua},r=function(e,t){const[a,i,n,r]=JSON.parse(e.id),[o,c]=JSON.parse(e.device),{ets:f,time:l,ts:u}=e,d={platform:"web",parent_id:a,area_id:i,seq_id:n,room_id:r,buvid:o,uuid:c,ets:f,time:l,ts:u},v=e.benchmark,g=["MD5","SHA1","SHA256","SHA224","SHA512","SHA384"];let y=JSON.stringify(d);for(const e of t)y=s[`Hmac${g[e]}`](y,v).toString(s.enc.Hex);return y}(n,e.secret_rule);try{const{data:e,code:s,message:c}=await async function(e){const{data:t}=await o.default.post("https://live-trace.bilibili.com/xlive/data-interface/v1/x25Kn/X",a.stringify(e));return t}(Object.assign({visit_id:"",csrf:t.csrf,csrf_token:t.csrf_token,s:r},n));return 0===s?(console.log(`向【${t.uname}】发送第${i.v}次心跳`),i.v++):console.log(`向【${t.uname}】发送第${i.v}次心跳失败`,s,c),e}catch(e){console.error(e)}}async function v(e=1,a=10){try{const{code:i,message:n,data:r}=await t.getLiveFansMedal(e,a);return 0!==i?(console.error("获取直播间失败 ",i,n),null):r}catch(e){return console.error("获取直播间异常",e.message),null}}async function g(e=!0){const a=await async function(){let e=0;try{var a,i;const{data:n,code:r}=await t.getGiftBagList();return 0!==r||(null===(a=n.list)||void 0===a?void 0:a.length)<=0?24:(null===(i=n.list)||void 0===i||i.forEach((a=>{if(30607===a.gift_id){const i=(1e3*a.expire_at-(new Date).getTime())/t.Constant.MS2DATE;i>6&&i<=7&&(e+=a.gift_num)}})),e>=24?0:24-e)}catch(e){}return 24}();let i;return e?i=await async function(){const{fansMedalList:e,pageinfo:t}=await v();let{totalpages:a}=t;if(a&&a>1){a=a>3?3:a;for(let t=2;t<=a;t++){const a=await v(t,10);e.push(...a.fansMedalList)}}return e}():({fansMedalList:i}=await v()),{fansMedalList:i,heartNum:a}}async function y(){console.log("----【直播心跳】----");const{heartNum:e,fansMedalList:t}=await g(),a=Math.ceil(e/(null==t?void 0:t.length));for(let i=0;i<a;i++)await _(t,e);console.log("完成")}async function p(e,a,i,n){if(!n.v||a[i])return new Promise((async r=>{await f(),await t.apiDelay(500),0===n.v?a[i]=await u(e,n):a[i]=await d(a[i],e,n),r("done")}))}async function _(e,a){return new Promise((async i=>{const n=[];for(let i=0;i<6;i++){let r=0;if(r>=a)break;const s=e.length;for(let o=0;o<s&&!(r>=a);o++){const a=e[o],{roomid:s,uname:f}=a,{room_id:u,area_id:d,parent_area_id:v}=await l(s),g=c(u,d,v,f,i);await p(g,n,o,{v:i}),await t.apiDelay(2e3),r++}i<5&&await t.apiDelay(6e4-2e3*r)}i("done")}))}exports.default=y,exports.liveHeart=y,exports.liveHeartBySCF=async function(e){var a;let i,n;if(e){const{d:a,hn:r}=JSON.parse(e);i="string"==typeof a?JSON.parse(t.gzipDecode(a)):a,n=r}else i=[{seq:{v:0}}],n={v:0};let r=0;if(null!==(a=i[0])&&void 0!==a&&a.seq.v){!function(e){const a=t.getLIVE_BUVID(),i=t.getBiliJct(),n=t.TaskConfig.USER_AGENT;e.forEach((e=>{e.baseData.ua=n,e.baseData.csrf=e.baseData.csrf_token=i,e.baseData.device[0]=a,e.baseData.id[2]=e.seq.v}))}(i);for(const e of i)if(await f(),e.data&&(e.data=await d(e.data,e.baseData,e.seq)),await t.apiDelay(1e3),r++,e.seq.v>5&&(e.seq.v=0,r>=n.v))return console.log("今日获取小心心完成"),0;if(i.find((e=>e.seq.v>5)))return 1}else{i.length=0;const{heartNum:e,fansMedalList:a}=await g();n.v=e;for(const e of a){if(0===n.v)return console.log("今日获取小星星已经达到 24"),0;if(r>=n.v)break;const{roomid:a,uname:s}=e,{room_id:o,area_id:d,parent_area_id:v}=await l(a),g={v:0},y=c(o,d,v,s,g.v);await f(),await t.apiDelay(500);const p=await u(y,g);i.push({data:p,baseData:y,seq:g}),r++}}return function(e){e.forEach((e=>{delete e.baseData.csrf,delete e.baseData.csrf_token,delete e.baseData.ua,e.baseData.device[0]=0}))}(i),{d:t.gzipEncode(JSON.stringify(i)),hn:n,l:i.length}},exports.runOneLoop=_;
